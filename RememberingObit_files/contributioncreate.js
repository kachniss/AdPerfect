var mod_contribution_create={main_container:null,main_desktop_container:null,main_mobile_container:null,emblem_selected_display:null,emblem_item_display:null,emblem_active_class:"ap-contribution-emblem-active",photo_error_container:null,photo_upload_dropzone:null,photo_display:null,photo_upload_max_class:"ap-contribution-max-photo-reached",milestone_event_selector:null,action_submit_btn:null,parent_container:null,photoupload_queue:0,photo_list:null,contribution_obj:{},init:function(){mod_contribution_create.main_container=$(".ap-contribution-create-container");mod_contribution_create.main_desktop_container=$("#ap-contribution-create-desktop-container");mod_contribution_create.main_mobile_container=$("#ap-contribution-create-mobile-container");mod_contribution_create.emblem_selected_display=$(".ap-contribution-emblem-item-selected");mod_contribution_create.emblem_item_display=$(".ap-contribution-emblem-item-container");mod_contribution_create.photo_error_container=$(".ap-contribution-field-error-photo-error");mod_contribution_create.photo_upload_dropzone=$(".ap-contribution-photo-upload-dropzone");mod_contribution_create.photo_display=$(".ap-contribution-photo-display");mod_contribution_create.milestone_event_selector=$(".ap-contributon-milestone-events");mod_contribution_create.action_submit_btn=$(".ap-contribution-submit");mod_contribution_create.photo_list=$("#ap-contribution-photo-list");},register_handler:function(){mod_contribution_create.main_container.on("click",".ap-contribution-emblem-item-container",mod_contribution_create.handle_emblem_select);mod_contribution_create.main_container.on("click",".ap-contribution-emblem-remove",mod_contribution_create.handle_emblem_remove);mod_contribution_create.photo_display.on("click",".ap-contribution-photo-remove",mod_contribution_create.handle_photo_remove);mod_contribution_create.milestone_event_selector.on("change",mod_contribution_create.handle_milestone_event_select);mod_contribution_create.main_container.on("blur",".ap-contribution-input",mod_contribution_create.handle_input_blur);mod_contribution_create.action_submit_btn.on("click",mod_contribution_create.handle_create_contribution);mod_contribution_create.photo_list.on("sortupdate",mod_contribution_create.photo_reorder);},photo_reorder:function(){var a=mod_contribution_create.contribution_obj.photos;var b={};$.each(mod_contribution_create.photo_list.find("li"),function(c,e){var d=$(e).attr("data-key");b[d]=a[d];});mod_contribution_create.contribution_obj.photos=b;},handle_emblem_select:function(d){d.preventDefault();var c=$(this).find(".ap-contribution-emblem-item");var a=c.attr("src");var b=c.attr("data-id");mod_contribution_create.emblem_selected_display.attr("src",a);mod_contribution_create.set_emblem_to_contribution_obj(b,a);mod_contribution_create.show_has_emblem_action_links();mod_contribution_create.add_active_emblem_class(b);},handle_emblem_remove:function(b){b.preventDefault();var a=mod_contribution_create.emblem_selected_display.attr("data-default");mod_contribution_create.emblem_selected_display.attr("src",a);mod_contribution_create.set_emblem_to_contribution_obj("","");mod_contribution_create.show_empty_emblem_action_links();mod_contribution_create.remove_active_emblem_class();},add_active_emblem_class:function(a){mod_contribution_create.remove_active_emblem_class();$(".ap-contribution-emblem-item-"+a).addClass(mod_contribution_create.emblem_active_class);},remove_active_emblem_class:function(){mod_contribution_create.emblem_item_display.removeClass(mod_contribution_create.emblem_active_class);},show_empty_emblem_action_links:function(){$(".ap-contribution-emblem-show-on-empty").show();$(".ap-contribution-emblem-hide-on-empty").hide();},show_has_emblem_action_links:function(){$(".ap-contribution-emblem-show-on-empty").hide();$(".ap-contribution-emblem-hide-on-empty").show();},set_emblem_to_contribution_obj:function(b,a){if(b){mod_contribution_create.contribution_obj.emblemID=b;mod_contribution_create.contribution_obj.emblem=a;return;}delete mod_contribution_create.contribution_obj.emblemID;delete mod_contribution_create.contribution_obj.emblem;},set_dropzone_behaviors:function(){if(typeof mod_obitsphotoupload!=="undefined"){if(typeof mod.contribution_create.dropzone_count!=="undefined"&&mod.contribution_create.dropzone_count){var b=mod.contribution_create.dropzone_count;while(b>-1){var a="ap-contribution-photo-upload-form-"+b;mod_obitsphotoupload.set_accept(a,mod_contribution_create.contribution_upload_photo_accept,mod.contribution_create.maximum_upload_error_message);mod_obitsphotoupload.set_success(a,mod_contribution_create.contribution_upload_photo_success);mod_obitsphotoupload.set_error(a,mod_contribution_create.contribution_upload_photo_error);mod_obitsphotoupload.set_complete(a,mod_contribution_create.contribution_upload_photo_complete);b--;}}}},get_photo_count:function(){var a=0;if(typeof mod_contribution_create.contribution_obj!=="undefined"&&typeof mod_contribution_create.contribution_obj.photos!=="undefined"){a=Object.keys(mod_contribution_create.contribution_obj.photos).length;}return a;},contribution_upload_photo_accept:function(){var a=mod_contribution_create.photoupload_queue+1;if(mod_contribution_create.get_photo_count()+a<=mod.contribution_create.maximum_upload){mod_contribution_create.disable_submit();mod_contribution_create.photoupload_queue++;return true;}else{return false;}},contribution_upload_photo_complete:function(a){if(a&&a.accepted){mod_contribution_create.photoupload_queue--;if(mod_contribution_create.photoupload_queue<=0){mod_contribution_create.enable_submit();}mod_contribution_create.photo_list.sortable({tolerance:"pointer",placeholder:"ap-contribution-thumbnail-placeholder"});mod_contribution_create.photo_list.disableSelection();}},contribution_upload_photo_success:function(a){var b=$.parseJSON(a);if(b.type==="ap_success"){mod_contribution_create.compose_contribution_photos(b);return;}mod_contribution_create.show_photo_error_message(b.message);},compose_contribution_photos:function(b){var c=b.message;var a={photo_s3_key:c.s3_key,source:c.source,thumbnail:c.thumbnail};if(c.handle){a.handle=c.handle;a.bucket=c.bucket;a.media_source=c.media_source;}mod_contribution_create.set_photos_to_contribution_obj(c.photo_key,a);mod_contribution_create.display_uploaded_photo(c.html);mod_contribution_create.hide_photo_error_message();mod_contribution_create.set_max_upload_class();},contribution_upload_photo_error:function(a){mod_contribution_create.show_photo_error_message(a.message);},handle_filestack_all_files_done:function(b,a){mod_contribution_create.photoupload_queue=0;$.each(a,function(d,c){var e={input_file:c,action_type:"upload-filestack-photos"};mod_contribution_create.submit_ajax(e,function(f){if(f.type==="ap_success"){mod_contribution_create.compose_contribution_photos(f);}else{mod_contribution_create.show_photo_error_message(f.message);}});});},handle_filestack_upload_error:function(c,a,b){if(b.message){mod_contribution_create.show_photo_error_message(b.message);}else{mod_contribution_create.show_photo_error_message(b);}},handle_filestack_meta_error:function(b,a){if(!a){return;}if(a===a.toUpperCase()){mod_contribution_create.show_photo_error_message(i18n.T(a));}else{mod_contribution_create.show_photo_error_message(a);}},set_max_upload_class:function(){var a=mod_contribution_create.get_photo_count();if(parseInt(a)>=parseInt(mod.contribution_create.maximum_upload)){mod_contribution_create.photo_upload_dropzone.addClass(mod_contribution_create.photo_upload_max_class);}else{mod_contribution_create.photo_upload_dropzone.removeClass(mod_contribution_create.photo_upload_max_class);}},show_photo_error_message:function(a){mod_contribution_create.photo_error_container.html(a).show();},hide_photo_error_message:function(){mod_contribution_create.photo_error_container.html("").hide();},set_photos_to_contribution_obj:function(a,b){if(b){if(typeof mod_contribution_create.contribution_obj.photos==="undefined"||typeof mod_contribution_create.contribution_obj.photos===null){mod_contribution_create.contribution_obj.photos={};}mod_contribution_create.contribution_obj.photos[a]=b;return;}delete mod_contribution_create.contribution_obj.photos[a];},display_uploaded_photo:function(c){var b=c.ContributionCreateDesktop;var a=c.ContributionCreateMobile;if(b){mod_contribution_create.main_desktop_container.find(".ap-contribution-photo-display").append(b);}if(a){mod_contribution_create.main_mobile_container.find(".ap-contribution-photo-display").append(a);}},handle_photo_remove:function(b){b.preventDefault();var a=$(this).attr("data-key");mod_contribution_create.set_photos_to_contribution_obj(a,"");$(".ap-contribution-photo-item-"+a).closest("li").remove();mod_contribution_create.set_max_upload_class();mod_contribution_create.hide_photo_error_message();},handle_milestone_event_select:function(){var b=$(this).val();var c={action_type:"get-milestone-fields",milestone_event_id:b};var a=$(this).find(":selected").attr("data-id");$(this).removeClass();$(this).addClass(a);$(this).addClass("ap-contributon-milestone-events");mod_contribution_create.submit_ajax(c,function(f){var h=f.message.html.ContributionCreateDesktop;var g=f.message.html.ContributionCreateMobile;$.extend(mod.contribution_create.validation_rules,f.message.validation_rules);mod_contribution_create.main_desktop_container.find(".ap-contribution-event-fields").html(h);mod_contribution_create.main_mobile_container.find(".ap-contribution-event-fields").html(g);mod_contribution_create.milestone_event_selector.val(b);if(typeof mod_dd!=="undefined"){mod_dd.change_dd_title(".ap-contributon-milestone-events");}mod_contribution_create.add_autocomplete_to_milestone_place(f.message.place_settings);var e=mod_contribution_create.main_desktop_container.find(".ap-contribution-event-fields select");if(typeof e.selectpicker==="function"){var d=mod_contribution_create.main_mobile_container.find(".ap-contribution-event-fields select");e.selectpicker("refresh");d.selectpicker("refresh");}});},add_autocomplete_to_milestone_place:function(b){var a=$(".ap-contribution-place");if(typeof mod_googleplace!=="undefined"){$.each(a,function(){var c=$(this).attr("id");var d=b[c];mod_googleplace.add_to_autocomplete(c,d);});}},validate_submit:function(){var a=true;$(".ap-contribution-input").each(function(b,c){if(!mod_contribution_create.validate_input($(c))){a=false;}});if(!mod_contribution_create.validate_milestone_date()){a=false;}return a;},validate_milestone_date:function(){var a=mod_contribution_create.parent_container.find(".ap-contribution-date");var b=true;$.each(a,function(){var e=$(this).attr("data-target");var c=$(this).attr("name");var d=mod_contribution_create.get_milestone_date(e);if($(".ap-contributon-milestone-events").val()!=="0"||d.day!==""||d.month!==""||d.year!==""){if(!is_valid_date(d.year,d.month,d.day)){mod_contribution_create.show_input_error_message(c,i18n.T("contribution_create_invalid_date"));b=false;return true;}}mod_contribution_create.hide_input_error_message(c);});return b;},validate_input:function(c){var e=$(c).attr("name");var a=$(c).val();if(mod.contribution_create.validation_rules!=null&&e in mod.contribution_create.validation_rules){var d=mod.contribution_create.validation_rules[e];var b=null;$.each(d,function(g,f){switch(g){case"required":if(f.value&&$.trim(a)===""){b=f.error_message;return false;}break;case"maxchars":if($.trim(a).length>f.value){b=f.error_message;return false;}break;case"minchars":if($.trim(a).length<f.value){b=f.error_message;return false;}break;case"datatype":return false;}});if(b!==null){mod_contribution_create.show_input_error_message(e,b);return false;}}mod_contribution_create.hide_input_error_message(e);return true;},handle_input_blur:function(){var c=$(this).attr("name");var b=$(this).val();var a=$(".ap-contribution-input[name="+c+"]");a.val(b);if($(this).is("select")){if(typeof mod_dd!=="undefined"){mod_dd.change_dd_title(a);}else{if(typeof $.selectpicker==="function"){a.selectpicker("refresh");}}}mod_contribution_create.validate_input($(this));},show_input_error_message:function(b,a){$(".ap-contribution-field-error-"+b).html(a).show();},hide_input_error_message:function(a){$(".ap-contribution-field-error-"+a).html("").hide();},handle_create_contribution:function(b){b.preventDefault();if($(this).hasClass("disabled")){return;}mod_contribution_create.hide_all_error_messages();mod_contribution_create.parent_container=$(this).closest(".ap-contribution-create-container");if(!mod_contribution_create.validate_submit()){scroll_to_element(mod_contribution_create.parent_container);return;}mod_contribution_create.set_milestone_fields_to_contribution_obj();mod_contribution_create.set_input_fields_to_contribution_obj(0);var a={action_type:"submit-contribution","contribution-data":mod_contribution_create.contribution_obj};mod_contribution_create.submit_ajax(a,function(c){if(c.type==="ap_fail"){$.each(c.message,function(e,d){mod_contribution_create.show_input_error_message(e,d);});}else{mod_contribution_create.disable_submit();location.href=append_url_segment("submit");}});},get_milestone_date:function(c){var a=mod_contribution_create.parent_container.find("."+c);var b={};$.each(a,function(){var d=$(this).attr("data-type");b[d]=$.trim($(this).val());});b.date=b.year+"-"+b.month+"-"+b.day;return b;},set_milestone_fields_to_contribution_obj:function(){delete mod_contribution_create.contribution_obj.eventFieldValues;delete mod_contribution_create.contribution_obj.event;var e=mod_contribution_create.parent_container.find(".ap-contribution-event-fields :input");var c={};var d={};$.each(e,function(){var k=$(this).attr("data-field-id");var g=$(this).attr("data-field-name");if(typeof k==="undefined"||typeof g==="undefined"){return true;}var i=$(this).attr("data-field-type");var j=$(this).val();if(i==="date"){var f=$(this).attr("data-target");var h=mod_contribution_create.get_milestone_date(f);j=h.date;}c[k]=j;d[g]=j;});if(!$.isEmptyObject(c)){mod_contribution_create.contribution_obj.eventFieldValues=c;}var b=mod_contribution_create.parent_container.find(".ap-contributon-milestone-events").val();if(parseInt(b)){var a={ID:b};if(!$.isEmptyObject(d)){$.extend(a,d);}mod_contribution_create.contribution_obj.event=a;}},set_input_fields_to_contribution_obj:function(b){var a=mod_contribution_create.parent_container.find(".ap-contribution-input");$.each(a,function(){if(!b){var c=$(this).parent(".ap-contribution-event-field").length?1:0;var e=$(this).parent(".ap-contribution-event-date").length?1:0;if(c||e){return true;}}var f=$.trim($(this).val());var d=$(this).attr("name").replace("ap-contribution-","");delete mod_contribution_create.contribution_obj[d];if(f!==""){mod_contribution_create.contribution_obj[d]=f;}});},hide_all_error_messages:function(){$(".ap-contribution-field-error").html("").hide();},enable_submit:function(){mod_contribution_create.action_submit_btn.removeClass("disabled");},disable_submit:function(){mod_contribution_create.action_submit_btn.addClass("disabled");},submit_ajax:function(a,b){var c={mod_contribution_create:"",ad_id:mod.contribution_create.ad_id,story_id:mod.contribution_create.story_id,page_type:wp.pagetype};mod_contribution_create.disable_submit();$.extend(c,a);return $.ajaxQueue({dataType:"json",url:"/ajax/post_form/",data:c,type:"POST",success:function(d){if(d===null){return;}if(typeof b==="function"){mod_contribution_create.enable_submit();b(d);}}});}};$(document).ready(function(){mod_contribution_create.init();mod_contribution_create.register_handler();mod_contribution_create.set_dropzone_behaviors();});