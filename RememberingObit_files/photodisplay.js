mod_photodisplay={overlay:$(null),flagged:false,owner_photo:$(null),offset_left:0,offset_right:0,photocarousel:$(null),photoslider:$(null),carousel_list:$(null),init:function(){mod_photodisplay.owner_photo=$(".ap-owner-photos");mod_photodisplay.overlay=$("#ap-photodisplay-photo-overlay");},register_handlers:function(){$(document).on("click",".ap-photodisplay-photo-item",mod_photodisplay.overlay_on).on("click",".ap-detail-overlay-closebtn",mod_photodisplay.overlay_off).on("click",".ap-view-more-photo",mod_photodisplay.overlay_on);mod_photodisplay.owner_photo.on("click",".ap-photodisplay-photo-item",mod_photodisplay.overlay_on);},overlay_on:function(){if(typeof mod.photodisplay.story_id==="undefined"){return;}if(mod_photodisplay.flagged===false){var a=$(this).attr("data-id");var c=$(this).attr("data-thumbnail");var b={action_type:"get_photos",contribution_id:a,photo_clicked:c,story_id:mod.photodisplay.story_id,number_of_pictures:mod.photodisplay.number_of_pictures};mod_photodisplay.submit_ajax(b,mod_photodisplay.build_photo_overlay);mod_photodisplay.flagged=true;}},overlay_off:function(){mod_photodisplay.offset_right=0;mod_photodisplay.offset_left=0;mod_photodisplay.overlay.hide().empty().append($('<a href="javascript:void(0)" class="ap-detail-overlay-closebtn">&times;</a>'));mod_photodisplay.flagged=false;},build_photo_overlay:function(e){var j=e.message.photo_clicked;mod_photodisplay.overlay=$("#ap-photodisplay-photo-overlay");mod_photodisplay.initial_clicked=j;var m=e.message.photo_source;var l=[];$.each(m,function(n,o){l[n]=o.src;});var g=e.message.photo_index;var h="";var d="";var b=$('<div class="ap-photodisplay-photocaption-bottom"></div>');$.each(m,function(n,p){var o=p.photo_caption;h+='<li><a href="#"><img src="'+p.src+'" class="ap-image-thumbnail img-responsive"/></a>'+o+"</li>";d+='<li><a href="#"><img src="'+p.src+'" class="ap-image-thumbnail img-responsive"/></a></li>';});var k=$(e.message.title_caption);var a=$('<div id="ap-photodisplay-photoslider" class="flexslider"></div>');var i=$('<div id="ap-photodisplay-photocarousel" class="flexslider"></div>');var c='<ul class="slides">'+d+"</ul>";var f='<ul class="slides">'+h+"</ul>";k.appendTo(mod_photodisplay.overlay);a.append(f).appendTo(mod_photodisplay.overlay);i.append(c).appendTo(mod_photodisplay.overlay);b.appendTo(mod_photodisplay.overlay);if(l.length===1){i.hide();}mod_photodisplay.overlay.show();mod_photodisplay.carousel_list=$("#ap-photodisplay-photocarousel").find("li");mod_photodisplay.activate_flexslider(g);},activate_flexslider:function(b){var f=$("#ap-photodisplay-photocarousel");var c=$(mod_photodisplay.carousel_list[b]);var e=$("#ap-photodisplay-photoslider");var d=$(".ap-photodisplay-photocaption-bottom");f.flexslider({controlNav:true,slideshow:false,itemWidth:210,itemMargin:5,asNavFor:e,start:function(){mod_photodisplay.carousel_list.removeClass("flex-active-slide");c.addClass("flex-active-slide");$(".flex-direction-nav a").removeClass("flex-disabled");}});e.flexslider({animation:"slide",controlNav:false,slideshow:false,touch:true,startAt:b,useCSS:false,animationLoop:false,start:function(){mod_photodisplay.adjust_carousel();var g=$(".flex-active-slide .flex-caption");d.html(g.html());},after:function(){var h=$(".flex-active-slide .flex-caption");d.html(h.html());var g=$("#ap-photodisplay-photoslider").find("li.flex-active-slide").index();mod_photodisplay.carousel_list.removeClass("flex-active-slide");$(mod_photodisplay.carousel_list[g]).addClass("flex-active-slide");mod_photodisplay.show_full_active_thumbnail();}});f.find("ul.slides").css("width","100%");f.find(".flex-viewport").css("height","115px");f.find(".slides li").css("margin-right",0);e.imagesLoaded().done(function(){var g=-1;e.find("img.ap-image-thumbnail").each(function(){var j=$(this);var i=j[0]["height"];g=i>g?i:g;});e.find("img.ap-image-thumbnail").each(function(){var j=$(this);var i=j[0]["height"];if(i<=g){j.closest("#ap-contribution-photoslider ul.slides").css("display","flex");j.closest("li").addClass("ap-centering-image");}});});$(window).resize(function(){mod_photodisplay.adjust_carousel();});$("#ap-photodisplay-photocarousel a.flex-next").click(mod_photodisplay.get_next);$("#ap-photodisplay-photocarousel a.flex-prev").click(mod_photodisplay.get_prev);$("#ap-photodisplay-photocarousel").on("click","li",mod_photodisplay.show_full_active_thumbnail);var a=$("#ap-photodisplay-photocarousel ul.slides");a.scroll(function(){var i=a.scrollLeft();var h=a.outerWidth();var g=a.get(0).scrollWidth;if(g-i===h){mod_photodisplay.add_more_photos("right");}else{if(i==0){mod_photodisplay.add_more_photos("left");}}});},get_next:function(){var b=$("#ap-photodisplay-photoslider");var a=$("#ap-photodisplay-photocarousel");if(b.find("li.flex-active-slide").index()==b.find("li img").not(".clone").length-1){mod_photodisplay.add_more_photos("right");}else{b.flexslider("next");a.flexslider("next");}},get_prev:function(){var b=$("#ap-photodisplay-photoslider");var a=$("#ap-photodisplay-photocarousel");if(b.find("li.flex-active-slide").index()==0){mod_photodisplay.add_more_photos("left");}else{b.flexslider("prev");a.flexslider("prev");mod_photodisplay.show_full_active_thumbnail();}},show_full_active_thumbnail:function(){var f=$("#ap-photodisplay-photocarousel").find(".slides");var a=f.find(".flex-active-slide");if(a.length===0){return;}var i=f.outerWidth();var j=a.outerWidth();var g=a.offset();var e=a.offsetParent().offset();var h=g.left-e.left;var c=f.scrollLeft();var k=null;if(h<0){k=c+h;}else{var d=h+j;var b=d-i;if(d>i){k=c+b;}}if(k!==null){f.animate({scrollLeft:k});}},add_more_photos:function(b){if(b==="left"){var c="left_arrow";if(mod_photodisplay.offset_left===0){mod_photodisplay.offset_left+=1;}else{mod_photodisplay.offset_left+=parseInt(mod.photodisplay.number_of_pictures);}}else{var c="right_arrow";mod_photodisplay.offset_right+=parseInt(mod.photodisplay.number_of_pictures);}var a={action_type:c,offset_right:mod_photodisplay.offset_right,offset_left:mod_photodisplay.offset_left,story_id:mod.photodisplay.story_id,initial_clicked_photo:mod_photodisplay.initial_clicked,number_of_pictures:mod.photodisplay.number_of_pictures};mod_photodisplay.submit_ajax(a,mod_photodisplay.add_to_flexslider);},add_to_flexslider:function(b){var g=b.message.photo_source;if(typeof g==="undefined"){if(b.message.direction_clicked==="left"){$("#ap-photodisplay-photocarousel a.flex-prev").disabled=true;}else{$("#ap-photodisplay-photocarousel a.flex-next").disabled=true;}return;}var d=$("#ap-photodisplay-photocarousel");var e=$("#ap-photodisplay-photoslider");var a=$("#ap-photodisplay-photocarousel ul.slides");var f=0;var c=a.children().first();$.each(g,function(j,l){var k=l.photo_caption;var h='<li><a href="#"><img src="'+l.src+'" class="ap-image-thumbnail img-responsive"/></a>'+k+"</li>";var i='<li><a href="#"><img src="'+l.src+'" class="ap-image-thumbnail img-responsive"/></a></li>';if(b.message.direction_clicked==="left"){a.prepend(i);e.data("flexslider").addSlide(h,0);e.data("flexslider").currentSlide=$("#ap-photodisplay-photocarousel li.flex-active-slide").index("#ap-photodisplay-photocarousel li");}else{$("#ap-photodisplay-photocarousel ul.slides").append(i);$("#ap-photodisplay-photoslider").data("flexslider").addSlide(h);}});c.prevAll().each(function(){f+=$(this).outerWidth();});if(b.message.direction_clicked==="left"){a.scrollLeft(f);}$("#ap-photodisplay-photocarousel li img").click(function(){var h=d.find("img").map(function(){return this.src;}).get();$("#ap-photodisplay-photocarousel li").removeClass("flex-active-slide");$(this).closest("li").addClass("flex-active-slide");var i=$(this).attr("src");e.flexslider(h.indexOf(i));});mod_photodisplay.carousel_list=$("#ap-photodisplay-photocarousel").find("li");},adjust_carousel:function(){var b=$("#ap-photodisplay-photocarousel");var a=0;b.find("img.ap-image-thumbnail").each(function(){var c=$(this);a+=c.outerWidth();});b.css("max-width",a);},submit_ajax:function(b,d,a){var c={mod_photodisplay:""};$.extend(c,b);$.ajax({dataType:"json",url:"/ajax/post_form/",data:c,type:"POST",success:function(e){if(e!==null){if(typeof d==="function"){d(e);}}},complete:function(){if(typeof a==="function"){a();}}});}};$(document).ready(function(){mod_photodisplay.init();mod_photodisplay.register_handlers();});